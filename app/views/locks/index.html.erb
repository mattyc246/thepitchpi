  <div>
    <meta charset='utf-8' />
    <title>Locate the user</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.css' rel='stylesheet' />
    <style>
    body { margin:0; padding:0;}
    #map {width:100%;height:75vh; }
    </style>
  </div>


<div class="container">

    <div class="mb-3">
        <h2><%= current_user.name %>'s Locks</h2>
    </div>

    <div class ="position-relative" id="everything-container">
        <div class="" id="button-container">
            <button id="<%= @user %>" value= "All" class='flygroup btn f-1'>Show All</button>
            <button id="show-control" class='btn'>Show Controls</button> <!-- show controls in mobile -->
        </div>

        <div id='map' class="pt-2 position-absolute" ></div>

        <div class="p-2 position-absolute mt-2 dont-show" id="locks-container">
            <div>
                <% @locks.order("id asc").group_by(&:group).each do |group, lock| %>
                    <div class="card text-dark border-light mb-3" style="max-width: 18rem; min-width: 18rem">
                        <div class="card-header d-flex">
                            
                            <div class="f-1">
                                <%= group %>
                            </div>
                            
                            <div class="ml-auto pr-2">
                                <input id="<%= lock.first.user_id %>" value= "<%= group %>" class='flygroup flying' type="image" width="25rem" src="/assets/ic_action_location_2.png"/>
                            </div>

                        </div>
                        <% lock.each do |lock| %>
                            <div class="card-body">
                                <div>
                                    <h5 class="card-title float-left f-3"><%= link_to lock.lock_name, user_lock_path(current_user.id, lock.id) %></h5>
                                    <div class="float-right d-flex">
                                        <div class="pr-2">
                                            <input type='image' src="/assets/ic_action_location_2.png" width="30rem" class='fly' value='<%=lock.longitude%>' name='<%=lock.latitude%>'/>
                                        </div>
                                        <div>
                                        <!-- Rounded switch -->
                                            <label class="switch" id="lock_status">
                                                <input type="checkbox" name="lock_status"
                                                    <% unless lock.status == "Unlocked" %>
                                                        <%= "checked" %>
                                                    <% end %> >
                                                <span id="slider-<%= lock.id %>" class="slider round"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% end %>
                    </div>
                <% end %>
            </div>
        </div>
        
        
    </div>
        
<script>
    // lock switch ajax
    $(document).ready(function() {
        $('.slider').click(function(){
            var slider_id = event.target.id.split('-')[1]

            $.ajax({
                url: '/locks/toggle_lock',
                method: 'GET',
                data: {toggle_id: slider_id},
                success: function(data){
                    var alert_message = data.notice
                    $(".navbar").after(`<div class="alert alert-warning w-50 mx-auto" role="alert">${alert_message}</div>`)
                    $(".alert").delay(2000).fadeOut('slow');
                },
                error: function(){}
            });
        });
    })

    // locks container toggle
    $('#show-control').click(function() {
        $('#locks-container').toggleClass("dont-show");
    });

    $('.flying').click(function() {
        $('#locks-container').toggleClass("dont-show");
    });
    
    // button div to follow scrolling (doesn't work right now)
    $('#everything-container').scroll(function() {
        $('button-container').css('top', $(this).scrollTop());
    });
  
// Script ----------Script ----------Script ----------Script ----------Script ---------

// initialize map---------------------------------------------------------------------
mapboxgl.accessToken = 'pk.eyJ1IjoibG9ja25yb2xscy10ZWFtMSIsImEiOiJjam4xM3FvcDYxYnZuM2ttOThyYTc2cjFwIn0.LXhAvekTPkv8HSJvQd-32w';
var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/mapbox/dark-v9',
    center: [101.63060418023838, 3.1352744737826583], // starting position
    zoom: 15 // starting zoom

});

// load 3D building to map----------------------------------------------------
map.on('load', function() {
    // Insert the layer beneath any symbol layer.
    var layers = map.getStyle().layers;

    var labelLayerId;
    for (var i = 0; i < layers.length; i++) {
        if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
            labelLayerId = layers[i].id;
            break;
        }
    }

    map.addLayer({
        'id': '3d-buildings',
        'source': 'composite',
        'source-layer': 'building',
        'filter': ['==', 'extrude', 'true'],
        'type': 'fill-extrusion',
        'minzoom': 15,
        'paint': {
            'fill-extrusion-color': '#aaa',

            // use an 'interpolate' expression to add a smooth transition effect to the
            // buildings as the user zooms in
            'fill-extrusion-height': [
                "interpolate", ["linear"], ["zoom"],
                15, 0,
                15.05, ["get", "height"]
            ],
            'fill-extrusion-base': [
                "interpolate", ["linear"], ["zoom"],
                15, 0,
                15.05, ["get", "min_height"]
            ],
            'fill-extrusion-opacity': .6
        }
    }, labelLayerId);
});

// existing locks tagged into map----------------------------------------------------
var geojson = {
  type: 'FeatureCollection',
  features: [
    <% @locks.each do |lock| %>
    {
    type: 'Feature',
    geometry: {
      type: 'Point',
      coordinates: [<%= lock.longitude %>, <%= lock.latitude %>]
    },
    properties: {
      title: "<%= lock.lock_name %>",
      group: "<%= lock.group %>",
      description: "<%= lock.status %>",
      link_to: "<%= user_lock_path(current_user.id, lock.id) %>",
      link_2: "<%= toggle_lock_path(lock.id) %>",
    }
  },

  <% end %>
  ]
};

// add markers in html to map
geojson.features.forEach(function(marker) {

  // create a HTML element for each feature
  var el = document.createElement('div');
  el.className = 'marker';

  // make a marker for each feature and add to the map-------------
  new mapboxgl.Marker(el)
    .setLngLat(marker.geometry.coordinates)
    .setPopup(new mapboxgl.Popup({ offset: 25 }) // add popups
    //.setHTML('<h5><a href="'+ marker.properties.link_to +'">' + marker.properties.title + '</a></h5><small>' + marker.properties.group + '</small><h4>' + marker.properties.description + '</h4>' + '<h5><a href="'+ marker.properties.toggle +'">' + 'Toggle' + '</a></h5>'))
    .setHTML(`<h5><a href="${marker.properties.link_to}">${marker.properties.title}</a></h5> <small>${marker.properties.group}</small> <h4>${marker.properties.description}</h4> <!-- <a href="${marker.properties.link_2}" class ="map-toggle">Toggle Lock</a> -->`))
    .addTo(map);
});

// fly to individual marker--------------------------------------------------------
$(".fly").click(function() {
    // Fly to a random location by offsetting the point -74.50, 40
    // by up to 5 degrees.
    $('#locks-container').toggleClass("dont-show");
    map.flyTo({
        center: [this.value, this.name],
        zoom: 19
    });
});

// fly to group-------------------------------------------------------------------------
$(".flygroup").click(function(e) {
  event.preventDefault()
  var place = this.value
    $.ajax({
      type: 'GET',
      url: '/locks/group_points',
      dataType:"json",
      data: {
        id: e.target.id,
        group: e.target.value
      },

      success: function(data) {
          var bbox = [
            [data.lngmax, data.latmax],
            [data.lngmin, data.latmin]
          ];
          map.fitBounds(bbox, {
            padding: {top: 100, bottom:100, left: 100, right: 100}
          });
      },
      error: function(error) {
        console.log(error);
      }
    });
  })

// Add geolocate present location control to the map-----------------------------------
map.addControl(new mapboxgl.GeolocateControl({
    positionOptions: {
        enableHighAccuracy: true
    },
    trackUserLocation: true
}));

// Add Navigation Controller
map.addControl(new mapboxgl.NavigationControl());

// Add Full screen BUtton
map.addControl(new mapboxgl.FullscreenControl());

</script>
