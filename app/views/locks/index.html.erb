<%= stylesheet_link_tag "boontek", media: "all" %>
  <div>
    <meta charset='utf-8' />
    <title>Locate the user</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.css' rel='stylesheet' />
    <!-- <style>
        body { margin:0; padding:0;}
        #map {width:100%;height:75vh; margin-bottom: 3vh }
    </style> -->
  </div>

<div class="container-fluid" style = "margin-top: 100px;">

    <div id="everything-container" class ="">
        <div id="locks-map-container" class="">
            <div id="locks-btn-container">
                <div class="" id="button-container">
                    <button id="<%= @user %>" value= "All" class='flygroup btn btn-block f-1 lock-page-btns'>Show All</button>
                    <button id="show-control" class='btn btn-block f-1 lock-page-btns'>Show Controls</button> <!-- show controls in mobile -->
                </div>

                <div id="locks-container" class="dont-show">
                    <% @locks.order("id asc").group_by(&:group).each do |group, lock| %>
                        <div id="bt-card" class="card text-dark mb-3">
                            <div id="bt-card-header" class="card-header d-flex bg-black">
                                <div class="f-1">
                                    <button id="<%= lock.first.user_id %>" value= "<%= group %>" class='flygroup flying btn btn-link f-1' ><%= group %></button>
                                </div>
                            </div>

                        <% lock.each do |lock| %>
                            <div id="bt-card-body" class="card-body">
                                <div id="" class="d-flex float-left">
                                    <input type='image' src="/assets/ic_action_location_2_white.png" height="30rem" class='fly pr-2' value='<%=lock.longitude%>' name='<%=lock.latitude%>'/>
                                    <h5 id="bt-lock-name" class="card-title f-3 my-auto"><%= link_to lock.lock_name, user_lock_path(current_user.id, lock.id), class:"f-1 btn-link bg-transparent" %></h5>
                                </div>

                                <div class="float-right d-flex">
                                    <div class="pr-2 my-auto">
                                        <% if lock.tracking == true %>
                                            <%= image_tag 'clock_icon_small.png', style:"height: 1.5rem", class:""%>
                                        <% end %>
                                    </div>
                                    <div>
                                        <!-- Rounded switch -->
                                        <label class="switch" id="lock_status">
                                            <input type="checkbox" name="lock_status"
                                                <% unless lock.status == "Unlocked" %>
                                                <%= "checked" %>
                                            <% end %> >
                                            <span id="slider-<%= lock.id %>" class="slider round"></span>
                                        </label>
                                    </div>
                                    <div id="lock_icon-<%= lock.id %>" class="pl-2 locked-color">
                                        <% if lock.status == "Unlocked" %>
                                            <%= image_tag ("unlocked_small_B.png"), height: "30rem", class: "" %>
                                        <% elsif lock.status == "Locked" %>
                                            <%= image_tag ("locked_small_color.png"), height: "30rem", class: "" %>
                                        <% end %>
                                    </div>
                                </div>

                            </div>
                        <% end %>
                        </div>
                    <% end %>
                </div>
            </div>

            <div id='map' class="lock-page-map"></div>
        </div>
    </div>
</div>

<script>
    // lock switch ajax
    $(document).ready(function() {
        $('.slider').click(function(){
            var slider_id = event.target.id.split('-')[1]

            $.ajax({
                url: '/locks/toggle_lock',
                method: 'GET',
                data: {toggle_id: slider_id},
                success: function(data){

                    if(data.status == "Locked"){
                        $(`#lock_icon-${slider_id}`).html('<img height="30rem" class="" src="/assets/locked_small_color.png">')
                    } else if(data.status == "Unlocked"){
                        $(`#lock_icon-${slider_id}`).html('<img height="30rem" class="" src="/assets/unlocked_small_B.png">')
                    }

                    var alert_message = data.notice
                    $(".navbar").after(`<div class="alert alert-warning w-50 mx-auto" role="alert">${alert_message}</div>`)
                    $(".alert").delay(2000).fadeOut('slow');
                },
                error: function(){}
            });

        });
    })

    // locks container toggle
    $('#show-control').click(function() {
        $('#locks-container').toggleClass("dont-show");
    });

    $('.flying').click(function() {
        $('#locks-container').toggleClass("dont-show");
    });

    // button div to follow scrolling (doesn't work right now)
    $(document).ready(function () {
        let top = $('#map').offset().top - parseFloat($('#map').css('marginTop').replace(/auto/, 0));
        $(window).scroll(function (event) {
            let y = $(this).scrollTop();
            //if y > top, it means that if we scroll down any more, parts of our element will be outside the viewport
            //so we move the element down so that it remains in view.
            if (y >= top) {
            let difference = y - top;
            $('#map').css("top",difference);
            }
        });
    });

// Script ----------Script ----------Script ----------Script ----------Script ---------

// initialize map---------------------------------------------------------------------
mapboxgl.accessToken = 'pk.eyJ1IjoibG9ja25yb2xscy10ZWFtMSIsImEiOiJjam4xM3FvcDYxYnZuM2ttOThyYTc2cjFwIn0.LXhAvekTPkv8HSJvQd-32w';
var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/mapbox/dark-v9',
    center: [101.63060418023838, 3.1352744737826583], // starting position
    zoom: 15 // starting zoom

});

// load 3D building to map----------------------------------------------------
map.on('load', function() {
    // Insert the layer beneath any symbol layer.
    var layers = map.getStyle().layers;

    var labelLayerId;
    for (var i = 0; i < layers.length; i++) {
        if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
            labelLayerId = layers[i].id;
            break;
        }
    }

    map.addLayer({
        'id': '3d-buildings',
        'source': 'composite',
        'source-layer': 'building',
        'filter': ['==', 'extrude', 'true'],
        'type': 'fill-extrusion',
        'minzoom': 15,
        'paint': {
            'fill-extrusion-color': '#aaa',

            // use an 'interpolate' expression to add a smooth transition effect to the
            // buildings as the user zooms in
            'fill-extrusion-height': [
                "interpolate", ["linear"], ["zoom"],
                15, 0,
                15.05, ["get", "height"]
            ],
            'fill-extrusion-base': [
                "interpolate", ["linear"], ["zoom"],
                15, 0,
                15.05, ["get", "min_height"]
            ],
            'fill-extrusion-opacity': .6
        }
    }, labelLayerId);
});

// existing locks tagged into map----------------------------------------------------
var geojson = {
  type: 'FeatureCollection',
  features: [
    <% @locks.each do |lock| %>
    {
    type: 'Feature',
    geometry: {
      type: 'Point',
      coordinates: [<%= lock.longitude %>, <%= lock.latitude %>]
    },
    properties: {
      title: "<%= lock.lock_name %>",
      group: "<%= lock.group %>",
      description: "<%= lock.status %>",
      link_to: "<%= user_lock_path(current_user.id, lock.id) %>",
      link_2: "<%= toggle_lock_path(lock.id) %>",
    }
  },

  <% end %>
  ]
};


// add markers in html to map
geojson.features.forEach(function(marker) {

    var el = document.createElement('div');
    el.className = 'marker-locked';

  // // create a HTML element for each feature
  // if(marker.properties.description == "Locked"){
  // } else {
  //   var el = document.createElement('div');
  //   el.className = 'marker-unlocked';
  // }



  // make a marker for each feature and add to the map-------------
  new mapboxgl.Marker(el)
    .setLngLat(marker.geometry.coordinates)
    .setPopup(new mapboxgl.Popup({ offset: 25 }) // add popups
    //.setHTML('<h5><a href="'+ marker.properties.link_to +'">' + marker.properties.title + '</a></h5><small>' + marker.properties.group + '</small><h4>' + marker.properties.description + '</h4>' + '<h5><a href="'+ marker.properties.toggle +'">' + 'Toggle' + '</a></h5>'))
    .setHTML(`<h5><a href="${marker.properties.link_to}">${marker.properties.title}</a></h5> <small>${marker.properties.group}</small> <h4>${marker.properties.description}</h4> <!-- <a href="${marker.properties.link_2}" class ="map-toggle">Toggle Lock</a> -->`))
    .addTo(map);
});

// fly to individual marker--------------------------------------------------------
$(".fly").click(function() {
    // Fly to a random location by offsetting the point -74.50, 40
    // by up to 5 degrees.
    $('#locks-container').toggleClass("dont-show");
    map.flyTo({
        center: [this.value, this.name],
        zoom: 19
    });
});

// fly to group-------------------------------------------------------------------------
$(".flygroup").click(function(e) {
  event.preventDefault()
  var place = this.value
    $.ajax({
      type: 'GET',
      url: '/locks/group_points',
      dataType:"json",
      data: {
        id: e.target.id,
        group: e.target.value
      },

      success: function(data) {
          var bbox = [
            [data.lngmax, data.latmax],
            [data.lngmin, data.latmin]
          ];
          map.fitBounds(bbox, {
            padding: {top: 100, bottom:100, left: 100, right: 100}
          });
      },
      error: function(error) {
        console.log(error);
      }
    });
  })

// Add geolocate present location control to the map-----------------------------------
map.addControl(new mapboxgl.GeolocateControl({
    positionOptions: {
        enableHighAccuracy: true
    },
    trackUserLocation: true
}));

// Add Navigation Controller
map.addControl(new mapboxgl.NavigationControl());

// Add Full screen BUtton
map.addControl(new mapboxgl.FullscreenControl());

</script>
